{% extends "base.html" %}
{% load course %}

{% block title %}
    Модуль {{ module.order|add:1 }}: {{ module.title }}
{% endblock %}
{% block sidebar %}
    <aside class="col-md-3 col-sm-12">
        <div class="sidebar" id="modules">
            {% block sidebar-items %}
                {% for m in module.course.modules.all %}
                    <div class="sidebar-item {% if m == module %}s-active{% endif %}" data-id="{{ m.id }}">
                        <a href="{% url "module_content_list" m.id %}" class="sidebar-link">
                            <span class="order">{{ m.order|add:1 }}.</span> {{ m.title }}
                        </a>
                    </div>
                    {% empty %}
                    <div class="sidebar-item">Модулей пока нет</div>
                {% endfor %}
            {% endblock %}
        </div>
    </aside>
{% endblock %}

{#<div data-id="{{ content.id }}">#}
{#    {% with item=content.item %}#}
{#        <p>{{ item }} ({{ item|model_name }})</p>#}
{#        <a href="{% url "module_content_update" module.id item|model_name item.id %}">#}
{#            Редактировать#}
{#        </a>#}
{#        <form action="{% url "module_content_delete" content.id %}" method="post">#}
{#            <input type="submit" value="Удалить">#}
{#            {% csrf_token %}#}
{#        </form>#}
{#    {% endwith %}#}
{#</div>#}

{% block content %}

    <div class="d-flex justify-content-between align-items-center">
        <h2>Курс "{{ module.course.title }}"</h2>
        <a href="{% url "course_module_update" module.course.id %}" class="btn btn-danger">
            Изменить модули</a>
    </div>
    <div class="module">
        <h4>Модуль {{ module.order|add:1 }}: {{ module.title }}</h4>
        <div id="module-contents">
            {% for content in module.contents.all %}
                <div data-id="{{ content.id }}" class="content-block">
                    {% with item=content.item %}
                        <p>{{ item }} ({{ item|model_name }})</p>
                        <div class="d-flex gap-5">
                            <a href="{% url "module_content_update" module.id item|model_name item.id %}">
                                Редактировать
                            </a>
                            <form action="{% url "module_content_delete" content.id %}" method="post">
                                <input type="submit" value="Удалить">
                                {% csrf_token %}
                            </form>
                        </div>
                    {% endwith %}
                </div>
                {% empty %}
                <p>В этом модуле еще нет контента</p>
            {% endfor %}
        </div>

        <h4 class="mt-4 mb-3">Добавить новый контент:</h4>

        <div class="d-flex gap-5 mb-4">
            <a href="{% url "module_content_create" module.id "text" %}" class="content-type">Текст</a>

            <a href="{% url "module_content_create" module.id "image" %}" class="content-type">Изображение</a>

            <a href="{% url "module_content_create" module.id "video" %}" class="content-type">Видео</a>

            <a href="{% url "module_content_create" module.id "file" %}" class="content-type">Файл</a>
        </div>

    </div>
{% endblock %}

{% block include_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5sortable/0.13.3/html5sortable.min.js"></script>
{% endblock %}

{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            var options = {
                method: 'POST',
                mode: 'same-origin'
            }

            const moduleOrderUrl = '{% url "module_order" %}';

            sortable('#modules', {
                forcePlaceholderSize: true,
                placeholderClass: 'placeholder'
            })[0].addEventListener('sortupdate', function (e) {

                modulesOrder = {};
                var modules = document.querySelectorAll('#modules div');
                modules.forEach(function (module, index) {
                    // update module index
                    modulesOrder[module.dataset.id] = index;
                    // update index in HTML element
                    module.querySelector('.order').innerHTML = index + 1;
                    // add new order to the HTTP request options
                    options['body'] = JSON.stringify(modulesOrder);

                    // send HTTP request
                    fetch(moduleOrderUrl, options)
                });
            });

            const contentOrderUrl = '{% url "content_order" %}';

            sortable('#module-contents', {
                forcePlaceholderSize: true,
                placeholderClass: 'placeholder'
            })[0].addEventListener('sortupdate', function (e) {

                const contentOrder = {};
                let contents = document.querySelectorAll('#module-contents .content-block');
                console.log(contents)
                contents.forEach(function (content, index) {
                    // update content index
                    contentOrder[content.dataset.id] = index;
                    // add new order to the HTTP request options
                    options['body'] = JSON.stringify(contentOrder);
                    fetch(contentOrderUrl, options)
                });
            });
        })
    </script>

{% endblock %}